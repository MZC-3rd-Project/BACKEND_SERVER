# GitHub Issue â†’ Jira ë™ê¸°í™”

name: Sync Issue to Jira

on:
  issues:
    types: [opened, edited, closed, reopened]

permissions:
  issues: write
  contents: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. ì´ìŠˆ ìƒì„± â†’ Jira ì´ìŠˆ ìƒì„± + ë§í¬ ì—°ê²°
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-jira-issue:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Create Jira Issue and Link Parent
        uses: actions/github-script@v7
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        with:
          script: |
            const title = context.payload.issue.title;
            const body = context.payload.issue.body || '';
            const issueUrl = context.payload.issue.html_url;
            const author = context.payload.issue.user.login;

            const jiraAuth = Buffer.from(
              `${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`
            ).toString('base64');

            const jiraHeaders = {
              'Authorization': `Basic ${jiraAuth}`,
              'Content-Type': 'application/json'
            };

            // â”€â”€ 1) íƒ€ì´í‹€ì—ì„œ Issue Type ê²°ì • â”€â”€
            let issueType = 'Task';
            if (/^\[EPIC\]/i.test(title)) issueType = 'Epic';
            else if (/^\[STORY\]/i.test(title)) issueType = 'Story';
            else if (/^\[BUGFIX\]/i.test(title)) issueType = 'Bugfix';

            // â”€â”€ 2) ë³¸ë¬¸ì—ì„œ ìƒìœ„ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#123 í˜•íƒœ) â”€â”€
            const parentMatches = body.match(/#(\d+)/g) || [];
            const parentIssueNumbers = [...new Set(
              parentMatches.map(m => parseInt(m.replace('#', '')))
            )];

            // â”€â”€ 3) Jira ì´ìŠˆ ìƒì„± â”€â”€
            // ë³¸ë¬¸ì„ codeBlockìœ¼ë¡œ ê°ì‹¸ì„œ ë§ˆí¬ë‹¤ìš´ íŠ¹ìˆ˜ë¬¸ìž ë¬¸ì œë¥¼ ì™„ì „ íšŒí”¼
            // JSON.stringifyê°€ \n, ", \, ` ë“±ì„ ëª¨ë‘ ì•ˆì „í•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„í•¨
            const descriptionText = [
              `GitHub Issue: ${issueUrl}`,
              `Author: ${author}`,
              '',
              '---',
              '',
              body
            ].join('\n');

            const createPayload = {
              fields: {
                project: { key: process.env.JIRA_PROJECT_KEY },
                issuetype: { name: issueType },
                summary: title,
                description: {
                  type: 'doc',
                  version: 1,
                  content: [
                    {
                      type: 'codeBlock',
                      attrs: { language: 'markdown' },
                      content: [
                        { type: 'text', text: descriptionText }
                      ]
                    }
                  ]
                }
              }
            };

            const createRes = await fetch(
              `${process.env.JIRA_BASE_URL}/rest/api/3/issue`,
              {
                method: 'POST',
                headers: jiraHeaders,
                body: JSON.stringify(createPayload)
              }
            );

            if (!createRes.ok) {
              const err = await createRes.text();
              core.setFailed(`Jira ì´ìŠˆ ìƒì„± ì‹¤íŒ¨: ${createRes.status} ${err}`);
              return;
            }

            const { key: jiraKey } = await createRes.json();
            core.info(`âœ“ Jira ì´ìŠˆ ìƒì„±: ${jiraKey} (${issueType})`);

            // â”€â”€ 4) GitHub ì´ìŠˆ íƒ€ì´í‹€ì— Jira í‚¤ ì¶”ê°€ â”€â”€
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              title: `[${jiraKey}] ${title}`
            });

            // â”€â”€ 5) GitHub ì´ìŠˆì— Jira ë§í¬ ì½”ë©˜íŠ¸ â”€â”€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸ”— Jira: [${jiraKey}](${process.env.JIRA_BASE_URL}/browse/${jiraKey})`
            });

            // â”€â”€ 6) ìƒìœ„ ì´ìŠˆì™€ Jira ë§í¬ ì—°ê²° â”€â”€
            for (const parentNum of parentIssueNumbers) {
              try {
                // GitHub ìƒìœ„ ì´ìŠˆ íƒ€ì´í‹€ì—ì„œ Jira í‚¤ ì¶”ì¶œ
                const parentIssue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parentNum
                });

                const parentTitle = parentIssue.data.title;
                const keyMatch = parentTitle.match(/^\[([A-Z]+-\d+)\]/);

                if (!keyMatch) {
                  core.info(`ìƒìœ„ ì´ìŠˆ #${parentNum}ì— Jira í‚¤ ì—†ìŒ, ë§í¬ ìƒëžµ`);
                  continue;
                }

                const parentJiraKey = keyMatch[1];

                // ì‚¬ìš© ê°€ëŠ¥í•œ link type ì¡°íšŒ í›„ ë§¤ì¹­
                const linkTypesRes = await fetch(
                  `${process.env.JIRA_BASE_URL}/rest/api/3/issueLinkType`,
                  { headers: jiraHeaders }
                );
                const linkTypesData = await linkTypesRes.json();

                // "Relates" ë˜ëŠ” ë¹„ìŠ·í•œ ì´ë¦„ ì°¾ê¸° (Jira ì„¤ì •ë§ˆë‹¤ ë‹¤ë¦„)
                const relatesType = linkTypesData.issueLinkTypes.find(
                  t => /relates/i.test(t.name) || /ê´€ë ¨/i.test(t.name)
                ) || linkTypesData.issueLinkTypes[0]; // fallback: ì²« ë²ˆì§¸ íƒ€ìž…

                const linkRes = await fetch(
                  `${process.env.JIRA_BASE_URL}/rest/api/3/issueLink`,
                  {
                    method: 'POST',
                    headers: jiraHeaders,
                    body: JSON.stringify({
                      type: { name: relatesType.name },
                      inwardIssue: { key: jiraKey },
                      outwardIssue: { key: parentJiraKey }
                    })
                  }
                );

                if (linkRes.ok || linkRes.status === 201) {
                  core.info(`âœ“ Jira ë§í¬: ${jiraKey} â†” ${parentJiraKey}`);
                } else {
                  const err = await linkRes.text();
                  core.warning(`âœ— ë§í¬ ì‹¤íŒ¨ ${jiraKey} â†’ ${parentJiraKey}: ${err}`);
                }
              } catch (err) {
                core.warning(`âœ— ìƒìœ„ ì´ìŠˆ #${parentNum} ì²˜ë¦¬ ì˜¤ë¥˜: ${err.message}`);
              }
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. ì´ìŠˆ ìˆ˜ì • â†’ Jira ì´ìŠˆ ì—…ë°ì´íŠ¸ (markdown-safe)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  update-jira-issue:
    if: github.event.action == 'edited'
    runs-on: ubuntu-latest
    steps:
      - name: Update Jira Issue
        uses: actions/github-script@v7
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const title = context.payload.issue.title;
            const body = context.payload.issue.body || '';
            const issueUrl = context.payload.issue.html_url;
            const author = context.payload.issue.user.login;

            // íƒ€ì´í‹€ì—ì„œ Jira í‚¤ ì¶”ì¶œ
            const keyMatch = title.match(/^\[([A-Z]+-\d+)\]/);
            if (!keyMatch) {
              core.info('Jira í‚¤ ì—†ìŒ, ì—…ë°ì´íŠ¸ ìƒëžµ');
              return;
            }

            const jiraKey = keyMatch[1];
            const jiraAuth = Buffer.from(
              `${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`
            ).toString('base64');

            const descriptionText = [
              `GitHub Issue: ${issueUrl}`,
              `Author: ${author}`,
              '',
              '---',
              '',
              body
            ].join('\n');

            const res = await fetch(
              `${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}`,
              {
                method: 'PUT',
                headers: {
                  'Authorization': `Basic ${jiraAuth}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  fields: {
                    summary: title,
                    description: {
                      type: 'doc',
                      version: 1,
                      content: [
                        {
                          type: 'codeBlock',
                          attrs: { language: 'markdown' },
                          content: [
                            { type: 'text', text: descriptionText }
                          ]
                        }
                      ]
                    }
                  }
                })
              }
            );

            if (res.ok || res.status === 204) {
              core.info(`âœ“ ${jiraKey} ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
            } else {
              const err = await res.text();
              core.setFailed(`âœ— ${jiraKey} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${res.status} ${err}`);
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. ì´ìŠˆ ë‹«íž˜ â†’ Jira Done ì „í™˜
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  close-jira-issue:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Transition Jira to Done
        uses: actions/github-script@v7
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const title = context.payload.issue.title;
            const keyMatch = title.match(/^\[([A-Z]+-\d+)\]/);
            if (!keyMatch) {
              core.info('Jira í‚¤ ì—†ìŒ, ìƒëžµ');
              return;
            }

            const jiraKey = keyMatch[1];
            const jiraAuth = Buffer.from(
              `${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`
            ).toString('base64');
            const jiraHeaders = {
              'Authorization': `Basic ${jiraAuth}`,
              'Content-Type': 'application/json'
            };

            // ì‚¬ìš© ê°€ëŠ¥í•œ transition ì¡°íšŒ
            const transRes = await fetch(
              `${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}/transitions`,
              { headers: jiraHeaders }
            );

            if (!transRes.ok) {
              core.setFailed(`Transition ì¡°íšŒ ì‹¤íŒ¨: ${transRes.status}`);
              return;
            }

            const { transitions } = await transRes.json();
            const doneTransition = transitions.find(
              t => /done|ì™„ë£Œ|closed|close/i.test(t.name)
            );

            if (!doneTransition) {
              core.warning(
                `"Done" transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°€ëŠ¥í•œ transition: ${
                  transitions.map(t => `"${t.name}" (id:${t.id})`).join(', ')
                }`
              );
              return;
            }

            const execRes = await fetch(
              `${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}/transitions`,
              {
                method: 'POST',
                headers: jiraHeaders,
                body: JSON.stringify({ transition: { id: doneTransition.id } })
              }
            );

            if (execRes.ok || execRes.status === 204) {
              core.info(`âœ“ ${jiraKey} â†’ "${doneTransition.name}"`);
            } else {
              const err = await execRes.text();
              core.setFailed(`âœ— ${jiraKey} transition ì‹¤íŒ¨: ${err}`);
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. ì´ìŠˆ ìž¬ì˜¤í”ˆ â†’ Jira ë‹¤ì‹œ ì—´ê¸°
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  reopen-jira-issue:
    if: github.event.action == 'reopened'
    runs-on: ubuntu-latest
    steps:
      - name: Transition Jira to To Do
        uses: actions/github-script@v7
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const title = context.payload.issue.title;
            const keyMatch = title.match(/^\[([A-Z]+-\d+)\]/);
            if (!keyMatch) {
              core.info('Jira í‚¤ ì—†ìŒ, ìƒëžµ');
              return;
            }

            const jiraKey = keyMatch[1];
            const jiraAuth = Buffer.from(
              `${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`
            ).toString('base64');
            const jiraHeaders = {
              'Authorization': `Basic ${jiraAuth}`,
              'Content-Type': 'application/json'
            };

            const transRes = await fetch(
              `${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}/transitions`,
              { headers: jiraHeaders }
            );

            if (!transRes.ok) {
              core.setFailed(`Transition ì¡°íšŒ ì‹¤íŒ¨: ${transRes.status}`);
              return;
            }

            const { transitions } = await transRes.json();
            const reopenTransition = transitions.find(
              t => /to.?do|open|backlog|í• .?ì¼|ìž¬ì˜¤í”ˆ|reopen/i.test(t.name)
            );

            if (!reopenTransition) {
              core.warning(
                `ìž¬ì˜¤í”ˆ transitionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°€ëŠ¥í•œ transition: ${
                  transitions.map(t => `"${t.name}" (id:${t.id})`).join(', ')
                }`
              );
              return;
            }

            const execRes = await fetch(
              `${process.env.JIRA_BASE_URL}/rest/api/3/issue/${jiraKey}/transitions`,
              {
                method: 'POST',
                headers: jiraHeaders,
                body: JSON.stringify({ transition: { id: reopenTransition.id } })
              }
            );

            if (execRes.ok || execRes.status === 204) {
              core.info(`âœ“ ${jiraKey} â†’ "${reopenTransition.name}"`);
            } else {
              const err = await execRes.text();
              core.setFailed(`âœ— ${jiraKey} transition ì‹¤íŒ¨: ${err}`);
            }
